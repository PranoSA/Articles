<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Looking into OpenVPN and Linux Networking Using Network Namespaces</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-interactiveBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="91003be6-148f-4f34-9b44-16ba4e6c7038" class="page sans"><header><h1 class="page-title">Looking into OpenVPN and Linux Networking Using Network Namespaces</h1><p class="page-description"></p></header><div class="page-body"><p id="135c44cd-b943-44c0-a611-883c5e95f49c" class=""><strong>By Phillip Adler</strong></p><p id="91a4534d-61ea-49b3-8ff2-214c691fa84a" class="">
</p><nav id="2d021c80-159e-4116-bf7e-ee13f66328a0" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#76cecff9-27e5-4e58-b1be-0f6170dd3155">What a VPN Accomplishes</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d611289e-5ba9-48a3-8ff8-0b47e70ebfe0">What We will be Doing</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#d8b6eeee-0d50-437e-8587-a3d174483a94">Setting up the “Clients” And “Server” Networks</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#11d0b972-6a98-4734-a168-b4316e82d3f9">Setup Network Namespaces</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#f9e8fa59-3a54-42b2-9ff0-658671fde3b2"><em>Create Virtual Ethernet Links </em></a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d0fdab9f-8f35-4eed-a31d-0b465b17a1a8">Move Links to the Correct Network Namespace</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#6423660f-d16b-469e-abc7-67456ecfeae1">Setting Up Networking</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#93143bda-b880-4e7d-bf54-8362cb04f07f">Create Routing Between s and r1</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#20cd1d67-b7df-47f5-bfa9-1f3cb305782a">Setting up Networking Between r1 and c1</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ad89f87d-4590-4986-8bb0-13918d1967f8">Silly Mistake I made Earlier: </a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#03f5718b-0242-44e7-abcc-50391f62bd2a">Finishing up the rest of it (server to r2, r2 to app)</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#c6cbfa4a-ae0e-4909-a7f5-3988425ae410">Setting up the Service and Client Application</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#16ff24f8-db36-4018-b0f3-c70b19abd406">Creating Certificates for Server &amp; Client</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#a1e4eb0c-b21c-4550-b51f-8eca04356e89">Creating The CA Certificate &amp; Key</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#6d96af9f-bba4-4cf1-9186-59cc8bfe44a5">Creating The Server Certificate and Keys</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#100ef250-fc2d-4741-9756-0509d7035ed5">Creating Key and Certificates for Client</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#5ec59a3f-9ffb-417f-a86d-5e447e916845">Distribute Keys to Server and Client</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#94c2c300-94d9-4c67-a936-506f655f8ce6">Configuring OpenVPN software and Creating OVPN File</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#6fbbfca9-c5af-4dd1-8561-bfe2233b32bb">Setting Up Networking for The Server</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#7d1484c3-1294-47d6-ae82-34dc82e3347f">First Trying to Reach the public Internet: </a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#7184bd1f-9538-439f-a34c-d59db655bfa0">Creating a pcap dump of the traffic </a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#77987394-21d1-4a82-80a4-a0cdb1204842">Mistake #2 → No POSTROUTING iptable rules configured</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#b6856ff5-1186-46ab-ad4c-9cf3d5f963d0">Now Running in subnet instead of net-30 mode</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#4b8f5dc6-9f12-4d1f-827b-d31bde38ba3a">Deep-Look Into VPN Networking</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#9633ea4f-90b1-4904-8755-70f39a9428c0">VPN vs. SSH Tunneling Experiment</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#cb8afd68-28da-4608-b7f1-8ea9ffc036fc">TAP Mode </a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#9207da90-9936-40c1-bde0-0931b906c152">Adding LDAP Authentication</a></div></nav><h1 id="76cecff9-27e5-4e58-b1be-0f6170dd3155" class="">What a VPN Accomplishes</h1><p id="ef2b1c31-257d-4a0d-b8f8-b9db54838115" class="">Note : What we are covering here is a TLS/SSL VPN, which means that the original IP+TCP payload is encrypted as payload in a TLS/SSL VPN Connection. </p><p id="0eaaf188-a9a6-48e1-aae7-f2a6ee010eb2" class="">What a VPN needs to accomplish</p><ol type="1" id="2ca3108c-2caf-4e0f-b3e7-b336bd6e37fc" class="numbered-list" start="1"><li>Encrypt all payloads  (Either Ethernet or L2 headers + IP headers + Transport headers + Transport Payload, or L2 headers + IP Headers + Transport headers + Transport Payload) in a tunnel between a client and a server, and never expose the original headers to a sniffing party, on (probably) all traffic leaving, which involves changing in routing rules</li></ol><ol type="1" id="1570f0fc-8b54-43c2-a029-2e5afa50420f" class="numbered-list" start="2"><li>Be able to bring up and bring down in minimal amounts of effort and time</li></ol><ol type="1" id="dfb4a9db-0d52-4295-9edd-93bdb28252a0" class="numbered-list" start="3"><li>In this instance, certificate validation before initializing a connection. </li></ol><ol type="1" id="b2c00f90-5fd2-462d-97ce-65d35e1b5b66" class="numbered-list" start="4"><li>Exhibit Desiring Forwarding Behavior (For example, is it connecting as an outsider to a LAN, is it going to be routed over the internet or to another L3 routing device? etc.)</li></ol><h1 id="d611289e-5ba9-48a3-8ff8-0b47e70ebfe0" class="">What We will be Doing</h1><p id="4159b93c-d1fd-4ff5-b56e-f34aa65b4c28" class="">This article was written largely because I was finding parts of the Networking confusing and had no idea how to go about debugging potential problems. Most of what is deciphered here is by looking through wireshark, rather than some fundamental knowledge of OpenVPN or VPNs in general.</p><p id="117def05-5642-4608-8a6d-5e38eb2e81ab" class="">We will be setting up a VPN between a client in TUN Mode (maybe at a later date, I will talk about TAP mode), and examining and debugging at a network layer problems if we don’t configure the VPN correctly. </p><p id="6aecb85d-73da-453f-9de3-9a77390b5860" class="">Each “agent” or “router” will operate with its own network stack in its own network namespace. This is partly to practice working with Linux networking and partly to be able to examine all components on a single machine.</p><h1 id="d8b6eeee-0d50-437e-8587-a3d174483a94" class="">Setting up the “Clients” And “Server” Networks</h1><p id="94633444-fb19-4ffc-bdc5-a164bd977a9a" class="">Since my Local Network Is 192.168.1.0/24, I will be running my address blocks for the VPN clients and server in the 192.168.0.0/16 range outside of this and a single non-conflicting route can be added to interfaces to still allow default traffic through my LAN.</p><p id="8a94f3ac-6de8-4e42-80c1-df52dfaa1ca1" class="">
</p><p id="73500b86-6830-47dc-ad1e-836648a7f471" class="">For a Quick View of what We’ll Be Setting up </p><figure id="f674dd19-d31b-47ce-a1e1-b5741d54a0ba" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled.png"><img style="width:841px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled.png"/></a></figure><p id="878b88ab-bda0-4f20-b43e-95cb3ace27be" class="">OpenVPN Server : Will run in Root Network Namespace</p><p id="5acada3c-33d1-4352-8d94-5a0deb5b0a16" class="">VPN Client1 : Will run in c1 Namespace</p><p id="fd2956dd-6460-4303-a69f-8161af016c49" class="">VPN Client2 : (Undecided)</p><p id="69a8493e-f1a3-48b6-ab04-2ca95f8a5466" class="">Service : (app Network Namespace)</p><p id="d905b9c2-ea6d-4999-b317-f0267d4df204" class="">Router 1 :  (r1 Network Namespace)</p><p id="470cd779-ad97-4e83-915f-f4e55db4f168" class="">Router #2 : (r2 Network Namespace)</p><p id="713589c9-4ef9-4ddf-863c-d2dddd94d23c" class="">
</p><p id="7a2042f9-a7e4-46b6-8c7e-c3ec31ef68c3" class="">The first thing we should do is bring up these networks and ensure routing is enabled between them. </p><p id="c0b6488b-4482-42ed-8097-ad6ba18f36c9" class="">Note * The Purpose of creating these networks is to demonstrate the results of tunneling, this actually isn’t representative of actual internet routing. Usually You’d have something like : </p><p id="961ed991-505c-4cad-b2da-09f95d22a097" class="">(TBD)</p><p id="a7750287-c28e-4bca-b427-d1b2a8520128" class="">
</p><p id="90275a0b-094e-4628-92c7-06f99012acca" class="">Shoutout to <a href="https://iximiuz.com/en/posts/container-networking-is-simple/">https://iximiuz.com/en/posts/container-networking-is-simple/</a> for a really good explanation of namespaces (network in particular) and veth and vbridge devices and how they are used by containers</p><h2 id="11d0b972-6a98-4734-a168-b4316e82d3f9" class="block-color-blue">Setup Network Namespaces</h2><pre id="d6856a2c-4ffe-4aa2-9c23-4333a8681f2b" class="code"><code>sudo ip netns add r1  #Network Namespace that the “The Internet” Router 1 Will Live in

sudo ip netns add r2 #Network Namespace that the “The Internet” Router 2 Will Live in

sudo ip netns add c2 #Network Namespace VPN Client #2 Will Live In

sudo ip netns add c1 #Network Namespace VPN Server Will Live In

sudo ip netns add app #Network Namespace Service Will Live In</code></pre><p id="747f727f-f48d-4fe3-8c34-4c9836d4f71c" class="">
</p><h2 id="f9e8fa59-3a54-42b2-9ff0-658671fde3b2" class=""><em>Create Virtual Ethernet Links </em></h2><p id="25433ae1-d268-4493-99d0-73850a7a336e" class=""><em>(We will simply create point to point links between routers, clients, and servers instead of using bridges as each host will be its own subnet). Remember, this is to demonstrate VPN networking and not actual</em></p><pre id="d6014c41-0683-461a-9710-802a740b9e08" class="code"><code>sudo ip link add veth1 type veth peer ceth1 #Link Between S and Router1

sudo ip link add veth2 type veth peer ceth2 #Link Between R1 and C1

sudo ip link add veth3 type veth peer ceth3 #Link Between S and R2

sudo ip link add veth4 type veth peer ceth4 #Link Between R2 and app</code></pre><p id="dee1d5de-5955-40b4-94f2-54b06fc3e5c9" class="">
</p><p id="1569bd13-de6e-4dda-89c4-e739c81b8ec4" class="block-color-pink_background">#Note That No IPs or Routes Have Been Assigned Yet</p><h3 id="d0fdab9f-8f35-4eed-a31d-0b465b17a1a8" class="">Move Links to the Correct Network Namespace</h3><pre id="d324033a-006e-4974-8042-a1a2c226ca8d" class="code"><code>sudo ip link set ceth1 netns r1

sudo ip link set veth2 netns r1

sudo ip link set ceth2 netns c1

sudo ip link set ceth3 netns r2

sudo ip link set veth4 netns r2

sudo ip link set ceth4 netns app</code></pre><p id="bb0582ee-2d38-427d-8c17-7c20a3a60dfb" class="block-color-pink_background">#Note That No IPs or Routes Have Been Assigned Yet</p><h2 id="6423660f-d16b-469e-abc7-67456ecfeae1" class="">Setting Up Networking</h2><h3 id="93143bda-b880-4e7d-bf54-8362cb04f07f" class="">Create Routing Between s and r1</h3><pre id="2d4e7b04-e100-4305-9683-cb9e4f462245" class="code"><code>sudo ip link set dev veth1 up
sudo ip addr add 192.168.5.10/24 dev veth1
sudo ip route add 192.168.6.0/24 dev veth1 via 192.168.5.11

#Enter r1 Namespace, or in a new shell
sudo nsenter --net=/var/run/netns/r1
sudo ip link set dev ceth1 up
sudo ip addr add 192.168.5.11/24 dev ceth1
sudo ip route add default dev ceth1 via 192.168.5.10

ping 192.168.5.10 #Test if Works
ping $eth0 #Replace with IP of your default gateway src ip of your root network namespae
exit 

#If you&#x27;d like, run a shell in that namespace in another process and confirm using
sudo lsns 
#This will tell you processes running in each namespace (including others)</code></pre><p id="58fd8324-41e0-4455-8a14-0265c1c78503" class="">
</p><h3 id="20cd1d67-b7df-47f5-bfa9-1f3cb305782a" class="">Setting up Networking Between r1 and c1</h3><pre id="425f45e8-7f28-4ac0-8bf9-e179ee3edf73" class="code"><code>
sudo nsenter --net=/var/run/netns/r1
sudo ip link set dev veth2 up
sudo ip addr add 192.168.6.10/24 dev veth2
exit 


#------------------               --------------------#

sudo nsenter --net=/var/run/netns/c1
sudo ip link set dev ceth2 up
sudo ip addr add 192.168.6.11/24 dev ceth2
sudo ip route add default dev ceth2 via 192.168.6.10

#Test Both Hops
ping 192.168.6.10 #Should Work, This confirms the correct routing in both directions
ping 192.168.5.10 #Should Work, But Doesn&#x27;t ?
exit

</code></pre><p id="c42ba690-7c03-4b06-a281-a94438bdd7a6" class="">
</p><p id="cb89cfad-d1c1-427e-9ba9-82efaa4efd9c" class="">How can we figure out what is happening? </p><p id="f47e1015-748d-4cb9-a35d-730b90dff987" class="">
</p><p id="fccf77b7-791c-4fff-a357-616f7073ffa7" class="">Look a<em>t Iptables -L -v -n </em></p><p id="6f6fd8d8-4d39-48c3-b9da-d65a9a2eee22" class="">This looks at the iptables filter table </p><p id="2ba29f81-1b52-4024-8d3d-379c6cb0fad3" class="">After running ping 192.168.5.10 I can see no increases in accepted packets for any chains</p><p id="17e61d01-8395-488a-bf48-9637b94ae1c6" class="">After running ping 192.168.6.11, I see increases in accepted packets in the OUTPUT and INPUT chains.</p><p id="5d99d390-391e-4c01-8bd7-e9a0978022f0" class="">This can quickly see if it there’s matches to a DROP target in the filter table in either the output or input chains.</p><p id="783c8f62-bf28-4428-93bc-cad0726b5f9e" class="">
</p><p id="57b952ab-b8fe-494f-a9e2-0c50ce566736" class="">Now running ping 192.168.5.10 from the c1 namespace</p><p id="df46aabe-6d99-485b-ad2e-346372551d42" class="">Using cat /proc/net/dev inside the r1 namespace</p><figure id="4197e706-fdd6-41b0-97b1-b5be1aaa06ac" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%201.png"><img style="width:1795px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%201.png"/></a></figure><p id="8c367eba-ba15-4e56-9782-e46966709142" class="">I can clearly see that packets are arriving on the veth2 interface, but nothing is being forwarded to the ceth1 interface (transmit), and nothing is responding,  but aren’t being Dropped by an iptables filter chain.</p><p id="5ca3d6e4-28a5-4a39-890f-02e713d0f667" class="">The extra confusion can be that when you try to ping a route that IS NOT reachable but with forwarding enabled, you will get an “ICMP Net Unavailable” Ping status response</p><p id="07e60a29-67a0-409c-917b-3326488bf6a8" class="">Fix: </p><pre id="9e8a6388-c759-4c5b-b6e5-9eea00a9c956" class="code"><code>#------------------               --------------------#

#Why Isn&#x27;t it Working? Simply because we need to configure our linux server
#As a Router that can forward ipv4 packets

#Now Lets Fix it
sudo nsenter --net=/var/run/netns/r1
sysctl -w net.ipv4.conf.all.forwarding=1

#To Confirm
sysctl net.ipv4.ip_forward
exit

sudo nsenter --net=/var/run/netns/c1
ping 192.168.5.10 #Should Work
exit</code></pre><p id="ab7ea615-802d-4016-950a-df4392678b2c" class="">Now ping 192.168.5.10 from c1 and record traffic in r1 again: </p><figure id="d1aed177-814e-4504-8ecb-22b756ff088b" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%202.png"><img style="width:1795px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%202.png"/></a></figure><p id="6db0f1fd-8e3f-447e-8524-a95f74949fab" class="">We can now equal increase in both transmit / receive columns for ceth1 </p><h3 id="ad89f87d-4590-4986-8bb0-13918d1967f8" class="">Silly Mistake I made Earlier: </h3><p id="c7965121-6db7-48b8-ac2d-b2d88f12fbb5" class="">I previously had created routes from 192.168.5.10/24 to 192.168.6.11/24 and vice versa by simply calling </p><pre id="a9f4caba-6315-487f-a4be-a576d3bf60de" class="code"><code>$ ip route add 192.168.6.0/24 dev veth1</code></pre><p id="b824e049-89f7-4288-8fa4-1a2d50fcf10b" class="">The result was this : (a6:* is ceth2 here trying to reach veth1) </p><figure id="3b233a27-ab2d-4dc2-8a6d-12562d10a630" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%203.png"><img style="width:1167px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%203.png"/></a></figure><p id="c90c6d8a-1ad3-47d5-acd9-67fb5f22f1bc" class="">Since veth1 had no idea if if 192.168.11.6 was on a switch, bridge, or on the opposite side of the router in a different network, it assumed it was on the same network and sent a bunch of arp requests when I tried to ping.</p><p id="164a4e41-497d-4135-a89a-733ceba1f753" class="">Specifying </p><pre id="7681066c-6758-429c-ae9f-d0277e0ddbf1" class="code"><code>ip route add 192.168.6.0/24 dev veth1 via 192.168.5.11 </code></pre><p id="f5275deb-6012-415f-9689-382fdc04da50" class="">told us that its on the opposite side of the router and to use the mac address of 192.168.5.11 (the gateway)  in the ethernet frame. </p><p id="2af5dd5d-e9ad-4342-9bf0-a66eecac3b67" class="">The “ip addr add” is necessary in c1 and app because it needs to know a source address to listen on and send packets on.</p><p id="72a5d968-36cf-47b9-ab96-6b6e0f9db7ef" class="">
</p><h3 id="03f5718b-0242-44e7-abcc-50391f62bd2a" class="">Finishing up the rest of it (server to r2, r2 to app)</h3><pre id="402e5b9f-692f-4092-8497-051dbeb43926" class="code"><code>#Back In Root Network Namespace
sudo ip link set veth3 up
sudo ip addr add 192.168.7.10/24 dev veth3 
sudo ip route add 192.168.8.0/24 dev veth3 via 192.168.7.11 


sudo nsenter --net=/var/run/netns/r2
sudo ip link set ceth3 up
sudo ip addr add 192.168.7.11/24 dev ceth3
sudo ip link set veth4 up 
sudo ip addr add 192.168.8.10/24 dev veth4
sudo sysctl -w net.ipv4.conf.all.forwarding=1
sudo ip route add default dev ceth3 via 192.168.7.10
exit

sudo nsenter --net=/var/run/netns/app
sudo ip addr add 192.168.8.11/24 dev ceth4 
sudo ip link set ceth4 up
sudo ip route add default dev ceth4 via 192.168.8.10

#Test if Forwarding Works
ping 192.168.7.10
python3 -m http.server 9000 #Keep Attached in a new shell
</code></pre><p id="6a3b3998-a8ec-4dec-a11f-2d1b625e7235" class="">
</p><p id="54f6b2ec-45b2-4521-a740-9f7303a23eec" class="">Back In Root Namespace</p><pre id="e51f33e9-465a-4807-83f1-8050701984f6" class="code"><code>ping 192.168.8.11 #Does Not Work 

#There&#x27;s a chance you may be able to demonstrate that it isn&#x27;t being forwarded to the right interface using:
traceroute 192.168.8.11


#Fix For Our Local Network (Manual Routing instead of a distributed routing protocol like OSPF)
sudo ip addr add 192.168.8.10/24 dev veth3
sudo ip

curl 192.168.8.11:9000 #Works, Gets HTML Page Back</code></pre><h1 id="c6cbfa4a-ae0e-4909-a7f5-3988425ae410" class="">Setting up the Service and Client Application</h1><p id="c26c8903-5899-4697-9df2-fe210e176e70" class="">The Client &amp; Server Application Will be a simple gRPC application to confirm the originator of the IP packets that reach the Server are indeed the VPN, and that the original payload is intact after exiting the VPN. </p><p id="b8d1031a-a6c4-4aef-bca6-09368d82d6e5" class="">(TBD)</p><h1 id="16ff24f8-db36-4018-b0f3-c70b19abd406" class="">Creating Certificates for Server &amp; Client</h1><p id="7badf40c-8629-4cc3-b89d-be00e849d1a8" class="">(Borrowed Largely From <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-an-openvpn-server-on-ubuntu-20-04#step-1-installing-openvpn-and-easy-rsa">https://www.digitalocean.com/community/tutorials/how-to-set-up-and-configure-an-openvpn-server-on-ubuntu-20-04#step-1-installing-openvpn-and-easy-rsa</a>)</p><p id="2995ed6c-632f-412f-8e73-2db6f7688c58" class="">
</p><ul id="d3f7b59d-bb70-40c9-90de-adc49991a378" class="bulleted-list"><li style="list-style-type:disc"><em>For now, just follow this tutorial (we’ll get to client2 later). Instead of using scp, decide how you are going to store the local certificate and keys.</em></li></ul><ul id="061c5b7e-a97f-4bbf-a61e-b10c61000af0" class="bulleted-list"><li style="list-style-type:disc"><em>Be sure to skip the optional parts of steps 7, and steps 8&amp;9 , later we’ll get to later. </em></li></ul><ul id="354a11cf-4df1-44f9-8db5-22cb66358c0e" class="bulleted-list"><li style="list-style-type:disc"><em>And use 192.168.5.10 for the VPN Server.</em></li></ul><ul id="d7718949-bcb6-44f4-808e-b70a208c1478" class="bulleted-list"><li style="list-style-type:disc"><em>For, now don’t run the Client or Server.</em></li></ul><p id="e7aa4d39-1cdd-4b8a-acd1-b812639b3298" class="">
</p><p id="c42f5456-55c7-4da1-b5d0-82c1e5359e88" class=""> The end result will be something like</p><ol type="1" id="e0f43876-fe42-4f20-aa5f-2bce0fa2d8f0" class="numbered-list" start="1"><li>A CA, Client, and Server key and signed certificates.</li></ol><ol type="1" id="e45ac9c9-f12b-4529-a088-6951730e30aa" class="numbered-list" start="2"><li>Server configured symmetric key exchange using ecc and sha512 for digest   </li></ol><ol type="1" id="e79d8f83-6af6-49c3-85e1-dc1f45c2f14e" class="numbered-list" start="3"><li>Pre-shared key (ta.key) for TLS-crypt setting</li></ol><ol type="1" id="19f46a14-34ed-4756-b330-13e73cbd665c" class="numbered-list" start="4"><li>Configured cipher for encryption</li></ol><ol type="1" id="d7252f77-6ba6-41f3-a065-06cfb855b677" class="numbered-list" start="5"><li>Message Digest algorithm for HMAC</li></ol><ol type="1" id="ff62a970-1ce0-47ff-940b-a98ffb1eb9ef" class="numbered-list" start="6"><li>Client Configuration File to talk to VPN IP (Use 192.168.5.10 in this instance) </li></ol><p id="d004cee6-e430-4ecb-8553-e4eaf0ebf48d" class="">
</p><p id="63d5f2be-e37f-4ea0-b24c-48e7634eb064" class="">
</p><p id="3efafd9c-d959-4933-a562-4f2cd8efde1a" class=""><del>The end Goal Is : </del></p><ol type="1" id="7172d5b6-c730-4d3c-9d30-9edded2a5ed4" class="numbered-list" start="1"><li><del>We have generated a self-signed Certificate Authority to ensure rooted trusted, that is distributed to both the Server and Client for mutual Authentication.</del></li></ol><ol type="1" id="efb24d86-32f2-40da-a582-4f50195560cb" class="numbered-list" start="2"><li><del>We have generated keys and certificates by the CA for both the server and client.</del></li></ol><ol type="1" id="7de0f543-6112-47ac-a29f-27c10fc8ff44" class="numbered-list" start="3"><li><del>The certificates and keys are distributed to both the client and server to use (passed into the OpenVPN software process). </del></li></ol><h3 id="a1e4eb0c-b21c-4550-b51f-8eca04356e89" class="">Creating The CA Certificate &amp; Key</h3><p id="4fe2e009-6a58-441f-9608-938ae6d217e5" class="">(TBD)</p><h3 id="6d96af9f-bba4-4cf1-9186-59cc8bfe44a5" class="">Creating The Server Certificate and Keys</h3><p id="4f10c282-60e0-4b41-b501-d924c05ed570" class="">(TBD)</p><h3 id="100ef250-fc2d-4741-9756-0509d7035ed5" class="">Creating Key and Certificates for Client</h3><p id="f5dc45f3-3178-4278-b45a-075b2334be6c" class="">(TBD)</p><h3 id="5ec59a3f-9ffb-417f-a86d-5e447e916845" class="">Distribute Keys to Server and Client</h3><p id="04fb337b-acd5-40ec-9cf7-f264b5e2e89c" class="">(TBD)</p><p id="1ac2e490-b8ec-496e-a35c-cb0ca6cf61d6" class="">
</p><h1 id="94c2c300-94d9-4c67-a936-506f655f8ce6" class="">Configuring OpenVPN software and Creating OVPN File</h1><p id="76878557-aa5d-46c5-8eff-5280475cc77d" class="">(TBD) </p><h1 id="6fbbfca9-c5af-4dd1-8561-bfe2233b32bb" class="">Setting Up Networking for The Server</h1><p id="e3ed4a36-a572-48e8-9ff3-e3447d158e0d" class="">Now that we have the server config file , the client config file,  </p><p id="9dddec0f-a3a8-4adf-8fb7-9e1932385d47" class="">Here we will understand the Linux IPTables and sysctl commands that will be needed to successfully turn the OpenVPN into a router / proxy for the client. </p><p id="617b737e-4468-4e11-b26f-fae166519a16" class="">
</p><h3 id="7d1484c3-1294-47d6-ae82-34dc82e3347f" class="">First Trying to Reach the public Internet: </h3><p id="648643fb-828e-4dcc-b4ad-d92bd6b711df" class="">
</p><h3 id="7184bd1f-9538-439f-a34c-d59db655bfa0" class="">Creating a pcap dump of the traffic </h3><p id="559c4b19-2705-440e-b0bb-f0e4a0212b7e" class="">
</p><p id="c07ccb7c-1f7c-465d-8846-0bed401b2936" class="">We will use tshark to records tracefiles</p><p id="4cd8f1ea-ac31-40c1-9342-82f9b5f0742b" class="">To begin recording in each network namespace)</p><p id="216fd186-b9de-4f9e-94c8-54e81839601b" class="">s: tshark -i eth0 -i tun0 -i veth1 -w capture-output-s.pcap</p><p id="8d28cf18-f743-4037-b2c0-b656b15d95c8" class="">c1: tshark -i ceth2 -i tun0 -w capture-out-c1.pcap</p><p id="139d8ef6-70d1-4e11-a5b7-04a92b495663" class="">r1: tshark -i ceth1 -i veth2 -w capture-out-r1.pcap</p><p id="6a66f76b-68ca-4266-b9e0-cde4295e73be" class="">r2: tshark -i ceth3 -i veth4 -w capture-out-r2.pcap</p><p id="d0b6bc79-c32d-4a85-874c-701a099623c2" class="">app: tshark -i ceth4  -w capture-out-app.pcap</p><p id="393cc62b-c28a-4af6-84bc-701c725ede7e" class="">
</p><p id="9a54673c-5e00-41b3-9cc6-c1600c1ae775" class="">-i is to read from an interface</p><p id="7b32f545-82ce-4423-a0ab-6d9ab9e7ae88" class="">-w is the output file</p><p id="d0d5b608-0f34-414d-bd76-e1b1e35e4e07" class="">
</p><p id="5b247635-e069-4654-ada0-0efc2ba705e1" class="">You’ll have 9 processes for this, all the tsharks, plus openvpn server, openvpn client, the python http server in app, and ping application running in the c1 network namespace.</p><p id="270d45f5-4d49-49d2-aaba-9fe9eb3761dc" class="">
</p><p id="be05bfe4-b5b5-47b9-84c2-54b9bece2a0a" class="">Start the VPN Server and Cient</p><p id="1bebea5a-6104-4f4e-be8f-870c05fc51fb" class="">Our c1 routes go from : </p><figure id="f66847c7-fca1-4328-9826-33febc04ffe1" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%204.png"><img style="width:1014px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%204.png"/></a></figure><p id="bcd16e07-ba0c-4daa-9229-eb475b30323e" class="">to: </p><figure id="fea0dd3d-3544-4cf7-a959-58b91c0d8b91" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%205.png"><img style="width:1030px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%205.png"/></a></figure><p id="e882b4bb-f8f1-4eec-9886-ee27382531c8" class="">This is what is meant by “Start Up Quickly” with no outside configuration to network clients, OpenVPN simply adds a new device and new ip route rules to forward what was previously non-matching traffic in the 128.0.0./1 and 0.0.0.0/1 range (essentially, everything but default will match over these) to the OpenVPN software.</p><p id="62a121c0-6550-470a-87c0-6b8cf8ad8aef" class="">
</p><p id="b3b96673-0806-4db7-b5c1-9544d7487643" class="">So anything outside of the 192.168.5.0/32, 192.168.6.0/24 and 192.168.5.10/24 will be routed through tun0 to 10.8.0.5.</p><p id="55e827a1-c043-498c-863f-84c97ca3e396" class="">Tuns do not operate at the L2 level.</p><p id="46a47044-bd5a-4a20-a3a9-5820ca9ea74e" class="">We can test this</p><pre id="e50e3604-f9c8-4c19-94ab-9487a471efae" class="code"><code>traceroute 172.31.250.216 #This is my default network interface for WSL
1   172.31.250.216  0.404ms  0.293ms  0.287ms

traceroute 192.168.5.10
1   192.168.6.10  0.004ms  0.003ms  0.002ms
  2   192.168.5.10  0.002ms  0.003ms  0.004ms

# I can see it exists on the 192.168.6.10 interface 
#Why is this </code></pre><p id="79e9194e-d9cb-49df-8fb0-37ba34f8df08" class="">
</p><p id="17f60bfb-fe01-4795-96b9-8ad1e8ca381d" class="">Take Note of ip addr</p><figure id="457aeaf2-a2c5-461e-8df5-348231185938" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%206.png"><img style="width:1723px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%206.png"/></a></figure><p id="00e88774-1aa6-484c-9d82-b44e8bd94f86" class="">We can see that tun has a peer here</p><p id="e620be1e-4313-4e70-8d60-4328ddd08485" class="">
</p><p id="99a44b26-d9f0-4fc4-b124-89cd821e2010" class="">I ran : </p><p id="95cc5351-3309-4583-afb0-acfec095ed18" class="">ping 192.168.5.10</p><p id="4a368cad-3feb-4493-8014-daf759816d4a" class="">traceroute 192.168.5.10</p><p id="724565f6-4c8b-44f4-9b81-b8560413dd52" class="">ping 172.31.250.216 </p><p id="cc397fae-e8e5-4c91-9559-874c966990db" class="">traceroute 172.31.250.216</p><p id="94a5cc0a-5d7f-4b3b-b0f9-633ea6142f04" class="">
</p><p id="a16a2009-cea0-441e-b68e-26417b60cbaf" class="">You can see How ICMP messages to 192.168.5.10 crossed straight over</p><figure id="d2c3e3bd-f4e2-47c9-b4e0-48b0e03ee620" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%207.png"><img style="width:1300px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%207.png"/></a></figure><p id="888257a4-2df4-4c16-bcb8-c112a076efbe" class="">But to 172.31.250.216</p><p id="269f4dc1-f711-409d-be70-8c0bc476dce9" class="">You can see that the request goes Tun → (OpenVPN client with new destination source ) → Ceth2 with default route via 192.168.6.10 to OpenVPN machine with Ceth2 IP Address </p><figure id="a58ebf5d-9f16-45e1-8b0d-6961e0678d39" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%208.png"><img style="width:1435px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%208.png"/></a></figure><p id="b5ba4e8f-154f-4cca-9847-74576bb772e0" class="">Mistake #1 → No Forwarding Allowed (On the root namespace)</p><p id="b85d91ce-e889-4393-9261-e97e9f3db0a5" class="">Neither pinging 192.168.8.11 nor 8.8.8.8 (Google DNS works)</p><p id="0f95e1df-4df9-454a-8573-d3756a218b91" class="">Fix:</p><p id="b09c5c8f-0f3e-465d-a347-ac2e10ee5dcf" class="">In root namespace</p><p id="93089547-8bd6-4d85-b41c-f5f1a13c67c9" class="">sysctl -w net.ipv4.conf.all.forwarding=1</p><p id="d1598775-1701-49e8-801a-4b47448aa0d5" class="">
</p><p id="7d732658-494e-4be9-b33c-63e79a95866d" class="">Now ping 192.168.8.11 works </p><figure id="3efdfa6b-b9e6-49bf-9c8b-8280e66020b3" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%209.png"><img style="width:930px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%209.png"/></a></figure><p id="b054b120-4214-4ddc-b5c9-bfe69fc37a6f" class="">but ping 8.8.8.8 does not </p><p id="92c487dc-ed10-4ad8-a97e-370cc2458cbb" class="">If we run traceroute 8.8.8.8 we get something like : </p><figure id="1ceb1c59-0bc4-4112-99bd-a3c24cdf4b6f" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2010.png"><img style="width:889px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2010.png"/></a></figure><p id="f8543ea6-b6f1-4fb2-9b8b-e119b6947aca" class="">What is going on?</p><p id="96802950-10e8-4eb2-9e43-320deaca377f" class="">Let’s recapture </p><p id="fe71f0a0-dee6-4407-9e79-564a1b8a669f" class="">On the client:</p><figure id="51d9cbfb-c21e-4d75-9034-b1f078b90047" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2011.png"><img style="width:1356px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2011.png"/></a></figure><p id="d96ef358-7c50-456b-81ee-4a76274f7604" class="">We simply see no reply - no “Host Unreachable”. This is because as far as the openvpn server namespace is aware of this, the host is seen as reachable (has a default route)</p><p id="595f8b49-081d-427c-a39d-9fec97e98b02" class="">On the server</p><figure id="9ada53b5-dbce-44c9-ac79-ce6a11ac8858" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2012.png"><img style="width:1402px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2012.png"/></a></figure><p id="15854c10-ee5f-4f29-b8c8-bd0c16efac0e" class="">A similar thing is happening (note that the two pings from 10.8.0.6 to 8.8.8.8, one is on the tun0 interface and the other is on the eth0 interface)</p><p id="50e6d98e-2dc6-4a1f-b050-9201a2873da7" class="">This is because the client sends a UDP packet that is to be delivered to the OpenVPN server listening at 192.168.5.10. It then decrypts and authenticates this UDP packet , which contains an IP Payload inside, in this case a ping. On the client side, this packet emerged was passed to tun0 which had an ip address of 10.8.0.6 </p><figure id="f9b751d2-ac72-45cb-9f86-6a41d31e4e43" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2013.png"><img style="width:820px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2013.png"/></a></figure><p id="62f74cc8-3833-4536-b705-63db8974dbf5" class="">What is happening is that the packet is being forwarded onto the local network with the src ip 10.8.0.6, something my local network has no clue on how to route</p><p id="421bbef9-3924-4ade-9ee7-48130ceee218" class="">What is happening on the “TUN” is that server essentially has a bunch of IP addresses over TUN interfaces with clients, </p><figure id="ff4cef30-e5dc-4052-9fb8-e64609290c0c" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2014.png"><img style="width:1393px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2014.png"/></a></figure><p id="a95d10a9-f4d4-428e-ad95-68b8564126aa" class="">This raw interface shows that there isn’t an L2 encapsulation layer - its straight L3.</p><p id="11c8def4-ecbc-40e9-bff1-492c9b560dea" class="">I’m guessing that the OpenVPN server tracks/understands that a packet with Src 10.8.0.6 has a pair 10.8.0.5 and handles that as part of the application, but I’m not sure. </p><p id="8497f7b4-ce07-4106-b12e-281ee52e43a0" class="">Essentially what we have here, is TUN acting as a sort of raw IP remote program data transfer (TUN is essentially a delivery mechanism through IP headers to application extended memory), but with the added benefit that the originating application does not have to be aware of this, its simply configured by changes in routing rules as we saw when we started the OpenVPN server and client. </p><p id="de5e5bd3-8f43-428a-a75e-5579dd50d758" class="">To learn more about Tun, you can search up how to interact with the tun device using ioctl calls in C, this entails specifying a pointer to a data structure with a  name in ioctl call to the tun device driver, and interacting it as a file descriptor. </p><h3 id="77987394-21d1-4a82-80a4-a0cdb1204842" class="">Mistake #2 → No POSTROUTING iptable rules configured</h3><p id="01162096-2bc7-4876-82dc-3c57e0bd7f0f" class="">
</p><p id="31a451b3-410b-4db0-a47a-0909f2ebc2f6" class="">Fix: </p><pre id="aeb794a8-88d1-41b4-9993-085de0e1379d" class="code"><code># sudo iptables -A POSTROUTING -t nat -j accept #Accept All on POSTROUTING chain in NAT table
sudo iptables -A POSTROUTING -t nat -s 10.8.0.0/16 -o eth0 -j MASQUERADE

#Confirm 
sudo iptables -L -v -t nat

#Now go back to the c1 netns
ping 8.8.8.8 #IT WORKS !!!!!!!!!!!

#Now inside root namespace
sudo iptables -L -v -t nat
#Watch packets match rules !!
#You can see each rule in the chain in the table match packets</code></pre><p id="3d4b0d27-c784-401b-bdaa-b0e1976cce7b" class="">What Masquerade is doing is making the machine running the VPN server act as a source nat. “-s” matches source ips (10.8.0.6 is inside of 10.8.0.0/16), and -o matches against an output device, and Masquerade tells to rewrite the TCP/IP headers to act as a Source NAT. </p><p id="f81f96c9-f2c9-4bba-ac57-83c351e67eef" class="">Interestingly enough the results of iptables -L -v -t nat will look like: </p><figure id="a31a86c7-70a3-4b80-a386-6ceb5bf317d7" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2015.png"><img style="width:1239px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2015.png"/></a></figure><p id="9d2fc71f-af17-498e-8fba-a973a8365332" class="">We will only see 1 packet, that’s because iptables actually only matches the connection and then uses conntrack state table to forward packets. </p><p id="c06ed494-adfb-4b9d-a00c-9da8faec6457" class="">Using contrack -L you can find the table entries: </p><figure id="e428cdc5-fbbe-4396-8750-442c6096149f" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2016.png"><img style="width:1843px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2016.png"/></a></figure><p id="8fca4758-c682-4bbc-ae3a-09d67bdde3f7" class="">Here, its not as interesting since there is no sports or dports, but we will show that in a minute with a TCP application</p><p id="560aab57-98da-472a-a8cb-a46dda30fdf4" class="">
</p><p id="f38d01fd-1953-46c0-9131-8afd4b54685e" class="">Mistake #3 → You are still using the 10.8.0.6 SRC when forwarding to the App Namespace.</p><p id="fde85fd0-109d-4d65-9f0e-a4c0ea626b89" class="">By capturing with tshark in the app namespace you can see this:</p><p id="2897f07a-c9db-4270-88ba-49eec675a886" class="">In the c1 namespace, run curl 192.168.8.11:9000</p><figure id="5a88e82f-7a9c-4957-a1a4-57ac8b2a91bc" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2017.png"><img style="width:1095px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2017.png"/></a></figure><p id="f8804bef-e95a-4c1a-bdc1-be0f7b369dbe" class="">You can see that we are forwarding packets with 10.8.0.6, and in this case, the packets will still be routed back properly (by coincidence, do not ever count on this).</p><p id="a926029e-9e25-4ad4-b82e-3df8d1f6148b" class="">This is because it follows 2 default gateway passes back to the OpenVPN server, which routes back everything in the “VPN Subnet Range” back to tun0 to have the response re-encrypted and sent back to 10.8.0.6 over the tunnel. </p><p id="f7b163e5-d31b-4de6-9623-b10d439f194b" class="">Now, write a similar source nat rule as before using masquerade </p><pre id="7499b6de-56fd-419d-b902-52d0629ea667" class="code"><code>sudo iptables -A POSTROUTING -t nat -s 10.8.0.0/16 -o veth3 -j MASQUERADE</code></pre><p id="6be30f96-1a89-4dd7-b78f-3b1634c94c2f" class="">Now capture again and spam curl from c1 and you will see: </p><figure id="0421ac6d-6cda-4541-a526-298b5e00846b" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2018.png"><img style="width:1705px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2018.png"/></a></figure><p id="2f3b3fd1-63d9-4e0e-8c21-46eabff72145" class="">You can see now that the packets inherit the IP address of the VPN interface connected to R2. </p><p id="b54d7eb6-c0b7-4feb-b578-90d3688d00d7" class="">Looking at conntrack </p><figure id="26d4d541-caaf-49f1-bea4-d73ab19ea9c8" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2019.png"><img style="width:1899px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2019.png"/></a></figure><p id="88822034-190c-4570-a9f0-24e5107f3152" class="">You can see the NAT mappings , (10.8.0.6 : 57492, 192.168.8.11:9000).</p><p id="ae59b73c-84ac-4332-b540-7c5b6d6d1636" class="">Its essentially forwarding port 57492 on that interface to 10.8.0.6: 57492, (in the first entry), if its a full cone NAT it will enforce matching IPs or incoming connections, I’m not sure if it is, but it will work for this instance.  The outbound source port in this instance is dynamically allocated </p><h3 id="b6856ff5-1186-46ab-ad4c-9cf3d5f963d0" class="">Now Running in subnet instead of net-30 mode</h3><p id="e505ee04-1cd6-4293-8311-6748a02e6250" class="">go to the server.conf file in /etc/openvpn/server and uncomment the line:</p><p id="ab20c818-9798-4e82-82a9-c9283bf8b304" class="">;technology subnet</p><p id="948f7f82-b277-4d7f-8fde-a30eda62a7c3" class="">
Now restart the openvpn server and restart the vpn clients and look at routes and links: </p><p id="6a315242-5c83-44c3-b66a-0ef069a3dab3" class="">On the Client</p><figure id="2af0e534-ecca-45b4-af14-e8a3a19ba86f" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2020.png"><img style="width:1756px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2020.png"/></a></figure><p id="70a35a9f-ff43-40ab-8fbe-814fbc6456aa" class="">On the Server</p><figure id="a593a479-37c6-47a0-9202-b19d3b688db0" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2021.png"><img style="width:1630px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2021.png"/></a></figure><p id="a6ec5711-9e59-4196-ab04-5eb8b11d4c71" class="">We can see that there is no “pair ” for each Tun and it does not allocate a /30 subnet to every client.</p><figure id="80feb1ac-2556-4117-a7ee-e5074f405c39" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2022.png"><img style="width:1447px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2022.png"/></a></figure><p id="78aba935-88f9-4c8c-96c7-b4cfe6644d13" class="">The 2 ICMP req/reply response to tun0 and eth0 interface capture.</p><p id="15920b93-327f-4d9f-850c-71829d109183" class="">We can see that the client has an address of 10.8.0.4, so its clearly not using a /30 otherwise this would be a broadcast address. </p><p id="bd437d60-92cf-40b1-b919-f32215ca7c0c" class="">
</p><figure id="03653da3-37a1-4a8e-9fd2-64e48e4b9238" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2023.png"><img style="width:1084px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2023.png"/></a></figure><p id="809e8b2d-7060-4658-9c0e-3058315bce11" class="">
</p><h1 id="4b8f5dc6-9f12-4d1f-827b-d31bde38ba3a" class="">Deep-Look Into VPN Networking</h1><p id="b9c58c66-22b3-4fe6-894a-37834bd3acce" class=""><del>Creating a Wireshark Dump of the Traffic: </del></p><p id="b4a0d104-34e2-400e-a256-c224a390553b" class=""><del>Viewing and Filtering Wireshark Traffic: </del></p><p id="a0a1f22c-7569-4eb8-8360-7b8813806dbe" class=""><del>Net-30 vs Subnet Topology: </del></p><p id="c8dbca53-49a4-4c75-a8e5-9b21bde6e8b3" class="">Tun vs. Tap Mode: </p><p id="95487342-608f-4089-8f69-36df516f5425" class="">Traceroute Before and After : </p><p id="dd016643-5d59-465d-813f-90cc69817034" class="">Adding STUN server Experiment:</p><p id="fd5e8e0c-24e8-48f5-a93a-a8d87e8ebfcc" class="">GRPC Server Experiment: </p><h1 id="9633ea4f-90b1-4904-8755-70f39a9428c0" class="">VPN vs. SSH Tunneling Experiment</h1><p id="430972ef-79d9-410b-881d-321326b3ce39" class="">Now Turn off both the VPN client and VPN server</p><p id="2b043687-6600-45c4-9e55-eb81cbf1a7a3" class="">Type in something like:</p><p id="a057087a-6d78-4d01-a662-0421b19ae1a2" class="">ssh -f -N -L 4438:192.168.8.11:9000 <a href="mailto:prano@172.31.250.216">prano@172.31.250.216</a></p><p id="52d7537b-e145-4652-86b7-c513bf26d5ff" class="">sudo ip link set lo up # OR whatever the loopback interface is</p><p id="2a358116-2c2d-4c62-9624-a6441100612b" class="">
</p><p id="c2475726-4d46-4216-a488-69f252c5ed6e" class="">Record Wireshark on app, c1, and root namespace (where the OpenVPN server was previously), removing tun0 from both c1 and s capture, but add lo to c1 capture.</p><p id="8a6785e4-b773-4958-831b-5a76d4f0c8df" class="">
</p><p id="450f2a98-3652-488c-b872-d34bf0400a7c" class="">Now try curl 127.0.0.1:4438</p><figure id="8fe3484f-7b98-481d-98d6-64a192388ba4" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2024.png"><img style="width:1531px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2024.png"/></a></figure><p id="31eed56a-a8a3-48c0-ab44-79dcf3f5363d" class="">on c1, you can see a separate TCP connection from the curl client being made to the SSH tunnel process, followed by an HTTP request, followed by an encrypted TCP payload (SSH/TLS protocol). You can see that its simply transferring data over an established SSH connection, and you can even see ACK TCP segments that have no encrypted payload.</p><p id="7b7b9542-3447-419c-8d34-5a26514aaa38" class="">
</p><p id="f9beda99-6091-4dea-924b-6ae1fd99ad25" class="">On the Server:</p><figure id="840fd118-1029-4465-90ab-22c0ececfd9b" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2025.png"><img style="width:1627px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2025.png"/></a></figure><p id="c6481096-fecf-41f3-8732-97c581d90e81" class="">You can see encrypted connections between the client and server, and re-encapsulated packets at re-encapsulated with new IP /TCP headers on the other side, a brand new TCP connection it seems like that transfers over the decrypted TCP payload to the other side is my best guess. </p><figure id="c01a2b61-5eb9-4a58-b9ea-14351009e845" class="image"><a href="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2026.png"><img style="width:1396px" src="Looking%20into%20OpenVPN%20and%20Linux%20Networking%20Using%20Ne%2091003be6148f4f349b4416ba4e6c7038/Untitled%2026.png"/></a></figure><p id="36c2c22b-b3e0-44fe-b854-0ebba46f225a" class="">Long story short, the difference is the client has to be aware to the level of establishing a connection to a known ssh tunnel listener on a localhost, and it involves full ssh access to a shell, while with openvpn users authenticate as nobody/nogroup. </p><p id="d41ee6d7-58c3-4aba-b8d9-48b81b6a7fe2" class="">SSH tunnel operates on the level of encrypting a TCP payload over a medium to a secure channel to transfer to a new connection with new TCP headers, with a VPN you can choose to masquerade the output or not, and raw IP packets are sent over where the encrypted payload includes IP headers and TCP headers that will be “re-established” upon decrypting. </p><h1 id="cb8afd68-28da-4608-b7f1-8ea9ffc036fc" class="">TAP Mode </h1><p id="877c74b8-242a-45b8-8684-6f14297f794c" class="">We saw that in Tun mode, that the packets to-be-encrypted did not have any L2 Layer headers. What happens is that its passed as a raw routable IP-frame and needs to be routed out an interface and inherit its MAC address (link),.  It would also preclude MAC broadcasts to learn addresses. If we wanted to act as an Ethernet device directly, we need to use TAP, which means that if we VPN to a VPN gateway and have the packet forwarded to a bridge or switch to be routed after learning a MAC address via ARP of the destination, you would need to have your own Address (also to respond to ARP requests). </p><p id="46603645-cfaf-4e98-8c1a-f14de9827a9e" class="">(Implementation TBD) </p><h1 id="9207da90-9936-40c1-bde0-0931b906c152" class="">Adding LDAP Authentication</h1><p id="8d5f57e4-2950-42a4-9236-d4546be87c78" class="">(TBD)</p><p id="39d171a5-0d58-4622-9fcd-330dc8dfcd32" class="">
</p><p id="12952119-50b4-4c91-9cd5-3f335a0907c1" class="">
</p></div></article></body></html>